<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Scan to Pay</title>
  <style>
    body { font-family: Arial; background:#f5f5f5; text-align:center; padding: 40px; }
    .card { max-width: 420px; margin: 0 auto; background:#fff; border-radius: 14px; padding: 22px; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    img { width: 260px; margin: 16px auto 8px; display:block; }
    .muted { color:#666; font-size: 14px; }
    .status { margin-top: 12px; font-weight: 700; }
    .timer { font-size: 16px; margin-top: 6px; }
    .danger { color:#c0392b; }
    .ok { color:#1e8449; }
    .btn { display:inline-block; margin-top: 12px; padding:10px 14px; border-radius: 10px; border: 1px solid #ddd; background:#fafafa; cursor:pointer; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Scan to Pay (Bakong KHQR)</h2>
    <div class="muted">Order: <b>{{ order_id }}</b></div>

    <img src="data:image/png;base64,{{ qr_base64 }}" alt="KHQR" />
    <div class="muted"><b>Amount:</b> {{ amount }} KHR</div>

    <div class="timer">Expires in: <span id="countdown">--:--</span></div>
    <div class="status" id="statusText">Waiting for payment...</div>

    <button class="btn" id="refreshBtn" style="display:none;" onclick="location.reload()">Refresh QR</button>
  </div>

<script>
  const orderId = "{{ order_id }}";
  const expiresAt = Number("{{ expires_at }}"); // epoch seconds
  const successRedirectUrl = "{{ success_redirect_url }}";
  const countdownEl = document.getElementById("countdown");
  const statusEl = document.getElementById("statusText");
  const refreshBtn = document.getElementById("refreshBtn");

  function fmt(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  }

  function updateCountdown() {
    const now = Math.floor(Date.now() / 1000);
    const left = expiresAt - now;

    if (left <= 0) {
      countdownEl.textContent = "00:00";
      statusEl.textContent = "QR Expired. Please refresh.";
      statusEl.className = "status danger";
      refreshBtn.style.display = "inline-block";
      return false;
    }

    countdownEl.textContent = fmt(left);
    return true;
  }

  async function pollStatus() {
    try {
      const res = await fetch(`/api/status/${orderId}`);
      const data = await res.json();

      if (data.status === "PAID") {
        statusEl.textContent = "Payment Success âœ… Redirecting...";
        statusEl.className = "status ok";

        // Redirect to your frontend success page
        // Pass orderId as query param
        const url = `${successRedirectUrl}?orderId=${encodeURIComponent(orderId)}`;
        setTimeout(() => window.location.href = url, 600);
        return;
      }

      if (data.expired) {
        statusEl.textContent = "QR Expired. Please refresh.";
        statusEl.className = "status danger";
        refreshBtn.style.display = "inline-block";
      } else {
        statusEl.textContent = "Waiting for payment...";
        statusEl.className = "status";
      }
    } catch (e) {
      // keep silent; network hiccup
    }
  }

  // countdown tick
  updateCountdown();
  setInterval(() => {
    const alive = updateCountdown();
    // only poll while not expired
    if (alive) pollStatus();
  }, 1000);

  // extra poll every 2 seconds
  setInterval(() => {
    if (updateCountdown()) pollStatus();
  }, 2000);
</script>
</body>
</html>
